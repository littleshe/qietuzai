<!DOCTYPE html>
<html>
<head>
<title>切图仔</title>
<meta charset="utf-8">
<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
<style>
#dropzone { border: 1px dashed #ccc; padding: 50px 0; text-align: center; border-radius: 5px }
.row { margin-top: 20px; }
.thumbnail{height:250px;overflow:hidden;background:#eee}
#footer{ text-align:center}
.loading{display:none}
</style>
</head>
<body>
<div class="container"> 
  <!-- 拖拽 -->
  <div class="row">
    <div class="col-md-12">
      <p>
      切图仔demo版 by <a href="https://github.com/littleshe">littleshe</a>，转载请保留信息</p>
      <p>感谢<a href="https://github.com/meltingice/psd.js">psd.js</a>
      </p>
      <div id="dropzone">
        <h3>请拖个psd进来</h3>
      </div>
    </div>
  </div>
  <!-- 表单 -->
  <div class="row">
    <form class="col-md-12">
      <button id="export_all" class="btn btn-default btn-lg" type="button" style="margin-right:20px;">导出所有图层</button>
      <span class="psd_info"></span>
      <label>
        <input type="checkbox" disabled checked>
        @2x和@3x切图</label>
        <span class="loading">正在解析中……</span>
    </form>
  </div>
  <!-- 图层 -->
  <div class="row" id="layer"></div>
</div>
<script src="bower_components/jquery/dist/jquery.min.js"></script>
<script type="text/javascript" src="lib/psd.min.js"></script>
<script type="text/javascript" src="lib/zip.min.js"></script>
<script type="text/javascript" src="lib/filesaver.js"></script>
<script type="text/javascript">
  (function () {
	 
	/*	
		1、拖入PSD,解析成json格式
		2、图片裁剪@2x,@3x
    3、单张图片导出
    4、图片批量导出zip
    ---------
	*/
	  
    var PSD = require('psd');
    
    var dropArea = document.getElementById('dropzone')
    
    var imgData = []
        
    
    dropArea.addEventListener('dragover', onDragOver, true);
    dropArea.addEventListener('drop', onDrop, true);
    
    $('#export_all').click(function(){  
      export_all()
    })

    function onDragOver(e) {
      e.stopPropagation();
      e.preventDefault();
      e.dataTransfer.dropEffect = 'copy';
    }

   function onDrop(e) {
     e.stopPropagation();
     e.preventDefault();
	   $('.loading').show()
     PSD.fromEvent(e).then(function (psd) {
		    psd.tree().descendants().forEach(function (node) {
			  if (node.isGroup()){
          return
        }
		  	render(node)
		  });

		setTimeout(function(){
			$('.loading').hide()
		},1)
    
      });
    }

  function export_all(){  
    var zip = new JSZip();
    //zip.file("Hello.txt", "Hello World\n");
    imgData.forEach(function(node){ 
         zip.file(node.name, node.data, {base64: true}); 
         zip.file(node.name2x, node.data2x, {base64: true});  
    })
    zip.generateAsync({type:"blob"}).then(function(content) {
        saveAs(content, "images.zip");
    });
  }
 

	function render(node){	
		var $item = $('<div class="col-xs-6 col-md-3"><a class="thumbnail"></a></div>')
		var $thumb = $item.find('.thumbnail')
    var img = node.toPng()
		var $img = $(img)
		//$('<p>'+ node.name +'</p>').appendTo($thumb)
		$img.appendTo($thumb)
		$thumb.attr({
			'download': node.name,
			'href': img.src,
			'target': '_blank'
		})
    
    var img_base64 = img.src
    var canvas = document.createElement('canvas')
    canvas.width = img.width/3*2
    canvas.height = img.height/3*2
    canvas.getContext('2d').drawImage(img,0,0,img.width/3*2,img.height/3*2);
    
    imgData.push({  
        name: node.name + '@3x.png',
        data: img_base64.replace('data:image/png;base64,',''),
        name2x: node.name + '@2x.png',
        data2x: canvas.toDataURL("image/png").replace('data:image/png;base64,',''),
    })
    
		$item.appendTo('#layer')
	}

  }());
  </script>
</body>
</html>
